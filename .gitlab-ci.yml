stages:
  - build
  - stage
  - deploy
  - notify

variables:
  BUILD_NUMBER: ${CI_BUILD_REF_NAME}_${CI_BUILD_REF}
  IMAGE_BASENAME: ${CI_REGISTRY}/gamestuff.info/xeno2

build_app:
  stage: build
  image: wodby/php:7.3
  cache:
    paths:
      - app/vendor
  artifacts:
    paths:
      - app/vendor
    expire_in: 1 day
  script:
    - cd app
    - composer install --no-dev --no-suggest --prefer-dist --optimize-autoloader --no-interaction --no-scripts

build_assets:
  stage: build
  image: wodby/node:8
  cache:
    paths:
      - app/node_modules
  artifacts:
    paths:
      - app/public/dist
    expire_in: 1 day
  script:
    - cd app
    - yarn install --non-interactive  --frozen-lockfile --production
    - yarn run build

stage_php:
  stage: stage
  image: docker:stable
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    IMAGE_TAG: ${IMAGE_BASENAME}/php:${BUILD_NUMBER}
  script:
    - docker info
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
    - docker build --pull -t "${IMAGE_TAG}" -f php.Dockerfile .
    - docker push "${IMAGE_TAG}"

stage_nginx:
  stage: stage
  image: docker:stable
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    IMAGE_TAG: ${IMAGE_BASENAME}/nginx:${BUILD_NUMBER}
  script:
    - docker info
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
    - docker build --pull -t "${IMAGE_TAG}" -f nginx.Dockerfile .
    - docker push "${IMAGE_TAG}"

deploy:
  stage: deploy
  image: lwolf/kubectl_deployer
  environment:
    name: prod
    url: http://xeno2.gamestuff.info
  only:
    - docker
  dependencies: []
  script:
    - /bin/sh deploy.sh ${CI_ENVIRONMENT_SLUG}
