stages:
  - build
  - stage
  - deploy
  - notify

variables:
  BUILD_NUMBER: ${CI_BUILD_REF_NAME}_${CI_BUILD_REF}
  APP_VERSION: ${CI_COMMIT_SHORT_SHA}
  IMAGE_BASENAME: ${CI_REGISTRY}/gamestuff.info/xeno2

build:
  stage: build
  image: docker:stable
  services:
    - docker:dind
  variables:
    COMPOSE_FILES: -f docker-compose.yaml -f docker-compose.production.yaml
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  script:
    - apk add --no-cache gcc libc-dev libffi-dev make openssl-dev py-pip python2-dev
    - pip install docker-compose
    - docker info
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
    - docker-compose ${COMPOSE_FILES} build
    - docker image tag ${IMAGE_BASENAME}/app:${BUILD_NUMBER} ${IMAGE_BASENAME}/app:latest
    - docker image tag ${IMAGE_BASENAME}/web:${BUILD_NUMBER} ${IMAGE_BASENAME}/web:latest
    - docker push ${IMAGE_BASENAME}/app:latest
    - docker push ${IMAGE_BASENAME}/app:${BUILD_NUMBER}
    - docker push ${IMAGE_BASENAME}/web:latest
    - docker push ${IMAGE_BASENAME}/web:${BUILD_NUMBER}

deploy:
  stage: deploy
#  only:
#    - master
  image: docker:stable
  tags:
    - docker
  variables:
    COMPOSE_FILES: -f docker-compose.yaml -f docker-compose.production.yaml
    DOCKER_HOST: tcp://${DEPLOY_HOST}:2376
    DOCKER_CERT_PATH: "certs"
    DOCKER_TLS_VERIFY: "1"
  before_script:
    - apk add --no-cache gcc libc-dev libffi-dev make openssl-dev py-pip python2-dev
    - pip install docker-compose
    - mkdir ${DOCKER_CERT_PATH}
    - echo "${DOCKER_MACHINE_CA}" > "${DOCKER_CERT_PATH}/ca.pem"
    - echo "${DOCKER_MACHINE_CLIENT_CERT}" > "${DOCKER_CERT_PATH}/cert.pem"
    - echo "${DOCKER_MACHINE_CLIENT_KEY}" > "${DOCKER_CERT_PATH}/key.pem"
  script:
    - docker-compose ${COMPOSE_FILES} down
    - docker-compose ${COMPOSE_FILES} pull
    - docker-compose ${COMPOSE_FILES} up --remove-orphans --detach --force-recreate
    - rm -rf ${DOCKER_CERT_PATH}

sentry:
  stage: notify
  image: getsentry/sentry-cli
  only:
    - master
  dependencies: []
  script:
    - sentry-cli releases new -p xeno2 ${BUILD_NUMBER}
    - sentry-cli releases set-commits --auto ${BUILD_NUMBER}
    - sentry-cli releases deploys ${BUILD_NUMBER} new -e prod
